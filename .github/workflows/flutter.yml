name: Flutter Build

on:
  workflow_dispatch:
    inputs:
      android:
        description: 'üì± Android (APK)'
        type: boolean
        default: true
      linux:
        description: 'üêß Linux'
        type: boolean
        default: false
      windows:
        description: 'ü™ü Windows'
        type: boolean
        default: false

jobs:
  build-android:
    if: ${{ inputs.android }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      - name: Cache pub
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-android-${{ hashFiles('pubspec.yaml') }}
          restore-keys: pub-android-
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/*.gradle*','**/gradle-wrapper.properties') }}
          restore-keys: gradle-
      - name: Recreate scaffold
        run: |
          mv lib lib_bak && mv pubspec.yaml pub_bak
          flutter create --org com.meow.app --project-name imperor_signal .
          rm -rf lib && mv lib_bak lib && mv pub_bak pubspec.yaml
      - name: Patch AndroidManifest
        run: |
          M=android/app/src/main/AndroidManifest.xml
          sed -i 's|<manifest|<manifest xmlns:tools="http://schemas.android.com/tools"|' $M
          for P in "android.permission.INTERNET" "android.permission.CAMERA" "android.permission.READ_MEDIA_IMAGES" "android.permission.READ_MEDIA_VIDEO" "android.permission.READ_EXTERNAL_STORAGE" "android.permission.WRITE_EXTERNAL_STORAGE"; do
            sed -i "/<manifest/a\\    <uses-permission android:name=\"$P\" />" $M
          done
          sed -i 's|</application>|    <provider android:name="androidx.core.content.FileProvider" android:authorities="${applicationId}.fileprovider" android:exported="false" android:grantUriPermissions="true"><meta-data android:name="android.support.FILE_PROVIDER_PATHS" android:resource="@xml/file_paths" /></provider>\n    </application>|' $M
      - name: Create file_paths.xml
        run: |
          mkdir -p android/app/src/main/res/xml
          printf '<?xml version="1.0" encoding="utf-8"?>\n<paths>\n  <external-path name="external_files" path="."/>\n  <cache-path name="cache" path="."/>\n</paths>' > android/app/src/main/res/xml/file_paths.xml
      - run: flutter pub get
      - run: flutter build apk --release
      - uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  build-windows:
    if: ${{ inputs.windows }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      - name: Cache pub
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\Pub\Cache
            .dart_tool
          key: pub-windows-${{ hashFiles('pubspec.yaml') }}
          restore-keys: pub-windows-
      - name: Recreate scaffold
        run: |
          Move-Item lib lib_bak
          Move-Item pubspec.yaml pub_bak
          flutter create --org com.meow.app --project-name imperor_signal .
          Remove-Item -Recurse -Force lib
          Move-Item lib_bak lib
          Move-Item pub_bak pubspec.yaml -Force
      - run: flutter config --enable-windows-desktop
      - run: flutter pub get
      - run: flutter build windows --release
      - name: Zip
        run: Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath windows-build.zip
      - uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: windows-build.zip

  build-linux:
    if: ${{ inputs.linux }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Linux deps
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libmpv-dev mpv
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      - name: Cache pub
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-linux-${{ hashFiles('pubspec.yaml') }}
          restore-keys: pub-linux-
      - name: Recreate scaffold
        run: |
          mv lib lib_bak && mv pubspec.yaml pub_bak
          flutter create --org com.meow.app --project-name imperor_signal .
          rm -rf lib && mv lib_bak lib && mv pub_bak pubspec.yaml
      - run: flutter config --enable-linux-desktop
      - run: flutter pub get
      - run: flutter build linux --release
      - uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: build/linux/x64/release/bundle/
