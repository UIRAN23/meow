#!/data/data/com.termux/files/usr/bin/bash

G='\e[32m'
B='\e[34m'
Y='\e[33m'
R='\e[31m'
N='\e[0m'

VER_FILE="$HOME/.fntm/version.txt"
RAW_CPP_URL="https://raw.githubusercontent.com/itoryon/meow/main/chat.cpp"
mkdir -p ~/.fntm && touch ~/.fntm/version.txt

echo -e "${G}[*] Проверка обновлений meoww Web...${N}"

# 1. Проверка места
FREE_MB=$(df /data | awk 'NR==2 {print int($4 / 1024)}')
if [ "$FREE_MB" -lt 100 ]; then
    echo -e "${R}[!] Мало места: $FREE_MB MB. Нужно 100 MB!${N}"
    exit 1
fi

# 2. Локальная версия
[ -f "$VER_FILE" ] && LOCAL_VER=$(cat "$VER_FILE") || LOCAL_VER="0.0"

# 3. Версия с GitHub (Исправленный поиск)
echo -e "${B}[*] Запрос версии с GitHub...${N}"
# Скачиваем первые 100 строк во временную переменную
RAW_CONTENT=$(curl -sL "$RAW_CPP_URL" | head -n 100)
# Ищем строку VERSION с любым количеством пробелов и возможным const
REMOTE_VER=$(echo "$RAW_CONTENT" | grep -E "VERSION\s*=" | cut -d'"' -f2 | head -n 1)

if [ -z "$REMOTE_VER" ]; then
    echo -e "${R}[-] Ошибка: версия на GitHub не найдена.${N}"
    echo -e "${Y}[!] Убедитесь, что в chat.cpp есть строка: string VERSION = \"5.0\";${N}"
    exit 1
fi

DO_INSTALL=false
if [ "$LOCAL_VER" == "$REMOTE_VER" ] && [ -f ~/meoww ]; then
    echo -e "${G}[+] Актуальная версия ($LOCAL_VER).${N}"
    read -p "Переустановить? (y/N): " reconf
    [[ $reconf =~ ^[Yy]$ ]] && DO_INSTALL=true
else
    echo -e "${Y}[!] Новая версия: $LOCAL_VER -> $REMOTE_VER${N}"
    read -p "Обновить? (Y/n): " conf
    [[ ! $conf =~ ^[Nn]$ ]] && DO_INSTALL=true
fi

# 4. Компиляция
if [ "$DO_INSTALL" = true ]; then
    echo -e "${B}[*] Сборка v$REMOTE_VER (Web Interface)...${N}"
    curl -L "$RAW_CPP_URL" -o "chat.cpp"

    # Добавляем проверку наличия httplib.h перед компиляцией
    if [ ! -f "httplib.h" ]; then
        curl -L "https://raw.githubusercontent.com/yhirose/cpp-httplib/master/httplib.h" -o "httplib.h"
    fi

    if clang++ -O3 chat.cpp -lcurl -lssl -lcrypto -lpthread -o ~/meoww; then
        echo "$REMOTE_VER" > "$VER_FILE"
        echo -e "${G}[OK] Успешно! Откройте http://localhost:8080 после запуска.${N}"

        # Обновляем ярлык
        mkdir -p ~/.shortcuts
        printf '#!/data/data/com.termux/files/usr/bin/bash\ntermux-wake-lock\necho "Сервер запущен на http://localhost:8080"\n~/meoww\n' > ~/.shortcuts/chat && chmod +x ~/.shortcuts/chat

        pkill -f "meoww" || true
        rm chat.cpp
    else
        echo -e "${R}[-] Ошибка компиляции!${N}"
        exit 1
    fi
else
    echo -e "${B}[*] Выход.${N}"
fi
